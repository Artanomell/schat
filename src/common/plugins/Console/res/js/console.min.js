var Console={current:"try",setName:function(a){var b=$(".server-name");b.length&&b.text(a)}};Console.feed={read:function(a){if("reply"==a.type){if(!a.path.length)return;var b=a.path;"try"==b&&(b="tryAccess");var c=a.cmd;c==FEED_METHOD_DELETE&&(c="del");try{Console.feed[a.feed][c][b](a)}catch(d){}}else if("body"==a.type)try{Console.feed[a.feed].body(a.data,a.id,a.status)}catch(d){}},console:{get:{},put:{},post:{},del:{}},storage:{get:{},put:{},post:{},del:{}},server:{get:{},put:{},post:{},del:{}},users:{get:{},put:{},post:{},del:{}}},Console.feed.console.get.tryAccess=function(a){Loader.spinner.remove("loading/try");var b=$("#page");200==a.status?Console.home.load():402==a.status?Console.login.load():403==a.status?(b.html('<div class="alert alert-error" data-tr="console_bad_server">'+Utils.tr("console_bad_server")+"</div>"),$("#page a").on("click",function(a){a.preventDefault(),ConsoleView.openUrl($(this).attr("href"))})):b.html('<div class="alert alert-error"><strong>'+a.status+"</strong> "+SimpleChat.statusText(a.status)+"</div>")},$(document).ready(function(){Loader.spinner.add("loading/try"),Modal.init(),SimpleChat.get(SimpleChat.serverId(),"console/try")}),"undefined"==typeof ConsoleView?ConsoleView={toPassword:function(a){return a},expirationText:function(a){return a},setName:function(){return!1},openUrl:function(){}}:(ConsoleView.feed.connect(Console.feed.read),ConsoleView.serverRenamed.connect(Console.setName)),Console.feed.console.get.login=function(a){"login"==Console.current&&($("#login-spinner").addClass("hide"),clearTimeout(Console.login.timeout),200==a.status?"admin"==$("#password").val()?Console.password.load():Console.home.load():Console.login.setError(402==a.status?"console_incorect_password":a.status))},Console.login={timeout:null,load:function(){$.ajax({url:"login.html",isLocal:!0,success:Console.login.loaded})},loaded:function(a){$("#page").html(a),Console.current="login",Utils.retranslate();var b=$("#password");b.focus(),$("#login").on("click.login",function(a){a.preventDefault(),b.val().length?(Console.login.removeError(),Console.login.timeout=setTimeout(function(){$("#login-spinner").removeClass("hide")},400),SimpleChat.get(SimpleChat.serverId(),"console/login",{password:ConsoleView.toPassword(b.val())})):Console.login.setError("console_empty_password")})},setError:function(a){$("#password-group").addClass("error");var b=$("#error");"number"==typeof a?(b.removeAttr("data-tr"),b.html("<strong>"+a+"</strong> "+SimpleChat.statusText(a))):(b.attr("data-tr",a),b.html(Utils.tr(a))),b.fadeIn("fast")},removeError:function(){$("#password-group").removeClass("error");var a=$("#error");a.removeAttr("data-tr"),a.hide()}},Console.feed.storage.put.password=function(a){console.log(a),$("#password-spinner").addClass("hide"),clearTimeout(Console.password.timeout),200==a.status?(Loader.spinner.add("loading/try"),SimpleChat.get(SimpleChat.serverId(),"console/try")):Console.password.setError(a.status)},Console.password={timeout:null,load:function(){$.ajax({url:"password.html",isLocal:!0,success:Console.password.loaded})},loaded:function(a){$("#page").html(a),Console.current="password",Utils.retranslate(),Console.password.adjustWidth();var b=$("#new-password");b.focus(),$("#save").on("click.password",function(a){a.preventDefault();var b=Console.password.verify();return""!==b?void Console.password.setError(b):(Console.password.timeout=setTimeout(function(){$("#password-spinner").removeClass("hide")},400),void SimpleChat.request(SimpleChat.serverId(),"put","storage/password",{value:ConsoleView.toPassword($("#new-password").val())}))}),$("#cancel").on("click.password",function(a){a.preventDefault(),Loader.spinner.add("loading/try"),SimpleChat.get(SimpleChat.serverId(),"console/try")})},verify:function(){var a=$("#new-password").val();if(a!==$("#confirm-new-password").val())return"console_password_mismatch";var b=a.length;return 0==b?"console_empty_password":8>b?"console_password_short":""},setError:function(a){$("#new-password-group").addClass("error"),$("#confirm-new-password-group").addClass("error");var b=$("#error");"number"==typeof a?(b.removeAttr("data-tr"),b.html("<strong>"+a+"</strong> "+SimpleChat.statusText(a))):(b.attr("data-tr",a),b.html(Utils.tr(a))),b.fadeIn("fast")},adjustWidth:function(){Utils.adjustWidth($(".control-label")),Utils.adjustWidth($("button"))}},"undefined"!=typeof SimpleChat&&SimpleChat.retranslated.connect(Console.password.adjustWidth),Console.home={load:function(){$.ajax({url:"home.html",isLocal:!0,dataType:"html",success:Console.home.loaded})},loaded:function(a){$("#page").html(a),Console.current="home",Utils.retranslate();var b=SimpleChat.channel(SimpleChat.serverId());null!==b&&Console.setName(b.Name),$("#nav-logout").on("click.home",Console.home.logout),$("body").on("click.name","#name-ok",Console.home.setServerName),$("#oauth-ok").on("click.oauth-ok",Console.home.setOAuthServer),$(".auth-checkbox").on("click.oauth",Console.home.setAuthMethods),$("#main-channel-block :checkbox").on("click.policy",Console.home.setPolicy),Utils.adjustWidth($("#about-server-block .field-row-label")),Utils.adjustWidth($("#users-online-block .field-row-label")),Console.home.online()},online:function(){Console.home.getFeed(FEED_NAME_SERVER),Console.home.getFeed(FEED_NAME_USERS);var a=SimpleChat.encryption(),b=$("#server-encryption");if(null!==a){b.removeAttr("data-tr"),b.removeClass("red-text");var c="";2==a.protocol?c="TLS v1":0==a.protocol&&(c="SSL v3"),b.html('<span class="green-text">'+c+"</span>");var d=a.daysToExpiry;d>0&&42>=d&&b.append(' <span class="orange-text">'+ConsoleView.expirationText(d)+"</span>"),0>=d&&b.append(' <span class="red-text" data-tr="console_cert_expired">'+Utils.tr("console_cert_expired")+"</span>")}else b.addClass("red-text"),b.attr("data-tr","no-encryption"),b.text(Utils.tr("no-encryption"))},getFeed:function(a){Console.feed[a].body(SimpleChat.feed(SimpleChat.serverId(),a,3),SimpleChat.serverId(),300),SimpleChat.feed(SimpleChat.serverId(),a,1)},prepare:function(a,b){return 300==b?(Loader.spinner.add("loading/"+a),!0):(Loader.spinner.remove("loading/"+a),200==b)},logout:function(a){a.preventDefault(),Loader.spinner.add("loading/logout"),SimpleChat.request(SimpleChat.serverId(),FEED_METHOD_DELETE,CONSOLE_FEED_ME_REQ)},setServerName:function(a){a.preventDefault(),ConsoleView.setName(SimpleChat.serverId(),$("#name-edit").val()),$("#modal").modal("hide")},setOAuthServer:function(a){a.preventDefault(),$("#oauth-group").removeClass("error"),SimpleChat.request(SimpleChat.serverId(),FEED_METHOD_PUT,SERVER_FEED_OAUTH_REQ,{value:$("#oauth-server").val()})},setAuthMethods:function(){var a=[];$("#anonymous-auth").is(":checked")&&a.push("anonymous"),$("#oauth-auth").is(":checked")&&a.push("oauth"),SimpleChat.request(SimpleChat.serverId(),FEED_METHOD_PUT,SERVER_FEED_AUTH_REQ,{value:a})},setPolicy:function(){var a=0;$("#use-main-channel").is(":checked")&&(a|=1),1&a&&$("#forced-join").is(":checked")&&(a|=2),2&a&&$("#disable-leave").is(":checked")&&(a|=4),Console.home.showPolicy(a),SimpleChat.request(SimpleChat.serverId(),FEED_METHOD_PUT,SERVER_FEED_POLICY_REQ,{value:a})},showPolicy:function(a){a=a||0;var b=$("#use-main-channel"),c=$("#forced-join"),d=$("#disable-leave");b.attr("checked",!!(1&a)),c.attr("checked",!!(2&a)),d.attr("checked",!!(4&a)),1&a?c.parent().show():c.parent().hide(),1&a&&2&a?d.parent().show():d.parent().hide()}},Console.feed.console.del.me=function(a){200==a.status&&(Loader.spinner.add("loading/try"),SimpleChat.get(SimpleChat.serverId(),"console/try")),Loader.spinner.remove("loading/logout")},Console.feed.server.body=function(a,b,c){if(Console.home.prepare(FEED_NAME_SERVER,c)&&a!==!1){var d=$("#server-version");d.text(a.version),d.append(' <i class="icon-os os-'+Pages.os(a.os)+'"></i>'),$("#oauth-auth").attr("checked",-1!=a.auth.indexOf("oauth")),$("#anonymous-auth").attr("checked",-1!=a.auth.indexOf("anonymous")),$("#oauth-server").val(a.oauth),Console.home.showPolicy(a.policy),$("#auth-block").fadeIn("fast"),$("#main-channel-block").fadeIn("fast")}},Console.feed.server.put.oauth=function(a){200!=a.status&&303!=a.status&&$("#oauth-group").addClass("error")},Console.feed.users.body=function(a,b,c){if(SimpleChat.serverId()==b&&Console.home.prepare(FEED_NAME_USERS,c)&&a!==!1){var d=$("#users-online-now"),e=$("#users-online-peak");d.text(a.count),e.text(a.peak.count),e.append(" "+DateTime.template(a.peak.date,!0))}},Modal.create.name=function(){var a=$("#modal-header h3");a.text(Utils.tr("console_server_name")),a.attr("data-tr","console_server_name"),$("#modal-body").append('<form id="title-form"><div id="name-group" class="control-group"><input id="name-edit" type="text" maxlength="20" class="input-append"><button id="name-ok" type="submit" class="btn btn-prepend" data-tr="ok">'+Utils.tr("ok")+"</button></div></form>");var b=SimpleChat.channel(SimpleChat.serverId());null!==b&&$("#name-edit").val(b.Name)},Modal.shown.name=function(){$("#name-edit").focus()},"undefined"!=typeof SimpleChat&&SimpleChat.online.connect(Console.home.online);